<head>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
</head>

<body class="min-h-screen antialiased bg-[#FAFAFA] font-[Inter]">
    <div class="p-4">
        <div class="mx-auto max-w-3xl text-base/7 text-gray-700">
            <!-- Top Nav: 目次 / 前へ / 次へ -->
            <div class="mb-3 flex items-center gap-2 text-sm">
                <a href="index.html" class="inline-flex items-center rounded-lg bg-white ring-1 ring-gray-300 text-gray-900 px-3 py-1.5 hover:bg-gray-50">目次へ戻る</a>
                <a href="01-intro.html" class="inline-flex items-center rounded-lg bg-white ring-1 ring-gray-300 text-gray-900 px-3 py-1.5 hover:bg-gray-50">← 前へ</a>
                <a href="03-attention.html" class="inline-flex items-center rounded-lg bg-white ring-1 ring-gray-300 text-gray-900 px-3 py-1.5 hover:bg-gray-50">次へ →</a>
            </div>
            <h1 class="text-xl font-bold border-l border-[rgba(0,0,0,.08)] pl-4 bg-blue-100 py-4">🔤 言葉を「トークン」に分解</h1>

            <!-- 体験セクション -->
            <section class="bg-white rounded-md my-4 p-4 border shadow-[0_2px_2px_rgba(0,0,0,0.04)] border-[rgba(0,0,0,.08)]">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">体験：テキストをトークンに分解</h2>

                <p class="mb-4">AIは文章をそのまま理解できません。まず「トークン」という小さな部品に分解します。日本語の場合、1文字や単語の一部がトークンになることが多いです。
                </p>

                <div class="flex flex-col gap-2 mb-4">
                    <label for="text" class="text-gray-700">入力テキスト：</label>
                    <textarea id="text" class="bg-white ring-1 ring-gray-200 rounded-md p-4 font-mono text-sm min-h-32"
                        placeholder="例：昨日、AIと一緒に新しいアプリを作った。すごく楽しかった！"></textarea>

                <div class="flex gap-4 items-center">
                    <button id="tokenize" class="inline-flex items-center rounded-lg bg-gray-900 text-white px-4 py-2 text-sm font-medium hover:bg-gray-800">分割する</button>
                    <button id="reset" class="inline-flex items-center rounded-lg bg-white ring-1 ring-gray-300 text-gray-900 px-4 py-2 text-sm font-medium hover:bg-gray-50">リセット</button>
                    <span id="status" class="text-gray-500 ml-4">待機中</span>
                </div>
                </div>

                <!-- 結果表示 -->
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <h3 class="font-medium text-gray-900 mb-4">トークン</h3>
                        <div id="tokens" class="flex flex-wrap gap-4 mt-0"></div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                        <div class="flex flex-wrap gap-4 text-sm text-gray-700">
                            <div>文字数: <strong id="charCount">0</strong></div>
                            <div>トークン数: <strong id="tokenCount">0</strong></div>
                            <div>平均文字/トークン: <strong id="avgLen">0.0</strong></div>
                            <div>記号: <strong id="symCount">0</strong></div>
                            <div>数字: <strong id="numCount">0</strong></div>
                            <div>英字: <strong id="latinCount">0</strong></div>
                        </div>
                    </div>
                </div>

                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 my-4" role="alert">
                    <p class="font-bold">💡なぜトークンに分けるの？</p>
                    <p>コンピュータは最終的に数値で処理します。テキストは小さなかたまり（トークン）に分けられ、それぞれに番号（ID）が振られます。実際の学習では、この番号をそのまま読むのではなく、番号を意味を表すベクトル（埋め込み）に変換し、語の並び（位置情報）と合わせて関係性のパターンを学習します。</p>
                </div>
            </section>
        </div>
    </div>

    <script>
        const textEl = document.getElementById('text');
        const tokensEl = document.getElementById('tokens');
        const statusEl = document.getElementById('status');
        const btnTokenize = document.getElementById('tokenize');
        const btnReset = document.getElementById('reset');

        const charCountEl = document.getElementById('charCount');
        const tokenCountEl = document.getElementById('tokenCount');
        const avgLenEl = document.getElementById('avgLen');
        const symCountEl = document.getElementById('symCount');
        const numCountEl = document.getElementById('numCount');
        const latinCountEl = document.getElementById('latinCount');

        const PRESET = '昨日、AIと一緒に新しいアプリを作った。すごく楽しかった！\nToday is 2025-09-21. v2.0-beta を試しています😊';
        textEl.value = PRESET;
        
        btnReset.addEventListener('click', () => {
            textEl.value = PRESET;
            tokensEl.innerHTML = '';
            setStats([], 0);
            status('リセットしました');
        });

        btnTokenize.addEventListener('click', () => {
            const t = textEl.value ?? '';
            const tokens = tokenize_o200k_approx(t);
            renderTokens(tokens);
            setStats(tokens, [...t].length);
            status('分割完了（o200k_base 近似）');
        });

        function status(s) { statusEl.textContent = s; }

        function renderTokens(tokens) {
            tokensEl.innerHTML = '';
            tokens.forEach((tok) => {
                const id = hash(tok);
                const label = `${JSON.stringify(tok)} (id:${id})`;

                const span = document.createElement('span');
                span.textContent = label;
                span.setAttribute('data-token', tok);
                span.className = 'inline-block bg-white ring-1 ring-gray-200 rounded-md px-4 py-2 text-gray-700 cursor-default hover:bg-gray-50';
                span.title = `len=${[...tok].length}`;
                tokensEl.appendChild(span);
            });
        }

        function setStats(tokens, charCount) {
            charCountEl.textContent = String(charCount);
            tokenCountEl.textContent = String(tokens.length);
            avgLenEl.textContent = tokens.length ? (charCount / tokens.length).toFixed(1) : '0.0';
            let sym=0, num=0, latin=0;
            for (const t of tokens) {
                if (/^[0-9]+([.,][0-9]+)?$/.test(t)) num++;
                else if (/^[A-Za-z]+$/.test(t)) latin++;
                else if (/^[\p{P}\p{S}]+$/u.test(t)) sym++;
            }
            symCountEl.textContent = String(sym);
            numCountEl.textContent = String(num);
            latinCountEl.textContent = String(latin);
        }

        // --- o200k_base 近似トークナイザ（正規表現による前処理に基づく） ---
        // 出典: OpenAI tiktoken の o200k_base 前処理パターン（pat_str）を参考に実装（近似）。
        // 参考: openai/tiktoken discussion #298, OpenAI Cookbook Tokenization
        function tokenize_o200k_approx(text) {
            if (!text) return [];
            // JSのUnicodeプロパティ対応。'i'は英語の短縮（'s など）に対応するため付与
            const pat = /[^\r\n\p{L}\p{N}]?[\p{Lu}\p{Lt}\p{Lm}\p{Lo}\p{M}]*[\p{Ll}\p{Lm}\p{Lo}\p{M}]+(?:'s|'t|'re|'ve|'m|'ll|'d)?|[^\r\n\p{L}\p{N}]?[\p{Lu}\p{Lt}\p{Lm}\p{Lo}\p{M}]+[\p{Ll}\p{Lm}\p{Lo}\p{M}]*(?:'s|'t|'re|'ve|'m|'ll|'d)?|\p{N}{1,3}| ?[^\s\p{L}\p{N}]+[\r\n/]*|\s*[\r\n]+|\s+(?!\S)|\s+/giu;
            const out = [];
            let m;
            while ((m = pat.exec(text)) !== null) {
                const tok = m[0];
                if (tok === '') continue;
                out.push(tok);
            }
            return out;
        }

        // 安定ID用の簡易ハッシュ
        function hash(str) {
            let h = 2166136261 >>> 0; // FNV-1a 32bit
            for (const ch of str) {
                h ^= ch.codePointAt(0);
                h = Math.imul(h, 16777619);
            }
            return (h >>> 0) % 100000; // 0..99999
        }
        // 初期表示
        (function init(){
            const tokens = tokenize_o200k_approx(textEl.value);
            renderTokens(tokens);
            setStats(tokens, [...textEl.value].length);
            status('読み込み完了（o200k_base 近似）');
        })();
    </script>
</body>
